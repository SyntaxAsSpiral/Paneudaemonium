name: 🌀 Bridge Sync Engine

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
  push:
    paths: ['scripts/generate_bridge_sync.py']

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Limited to current repo (Paneudaemonium)
    
    steps:
      - name: 🜍 Checkout Paneudaemonium
        uses: actions/checkout@v4
        with:
          path: paneudaemonium
        
      # Note: Repo access tokens needed for private repos
      # - name: 🜃 Checkout Lexigon-Semantra
      #   uses: actions/checkout@v4
      #   with:
      #     repository: SyntaxAsSpiral/Lexigon-Semantra
      #     path: semantra
      #     token: ${{ secrets.SYNC_TOKEN }}
          
      # - name: 🜂 Checkout Lexigon-Bridge
      #   uses: actions/checkout@v4
      #   with:
      #     repository: SyntaxAsSpiral/Lexigon-Bridge
      #     path: bridge
      #     token: ${{ secrets.SYNC_TOKEN }}

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 🔍 Guard-Rail Check (Dry-run enforcement)
        run: |
          echo "INIT_RUN=${{ secrets.INIT_RUN }}" >> $GITHUB_ENV
          echo "🛡️ Initial run guard: ${{ secrets.INIT_RUN }}"
          
      - name: 🔮 Execute Bridge Sync (Dry-run)
        working-directory: paneudaemonium
        run: |
          echo "🛡️ Simulating dry-run (repos not available in GitHub Actions)"
          echo "DRY_RUN_EXIT=0" >> $GITHUB_ENV
          echo "CHANGES_DETECTED=0" >> $GITHUB_ENV
          # python scripts/generate_bridge_sync.py --dry-run
          
      - name: 📋 Check for Changes Detected
        working-directory: paneudaemonium
        run: |
          echo "📝 Simulated change detection (already set in dry-run step)"
          echo "CHANGES_DETECTED: ${{ env.CHANGES_DETECTED }}"
          
      - name: ⚡ Execute Full Sync (Production)
        if: env.CHANGES_DETECTED != '0' && env.INIT_RUN != 'true'
        working-directory: paneudaemonium
        run: |
          echo "🌀 Executing full Bridge sync..."
          python scripts/generate_bridge_sync.py
          echo "FULL_SYNC_EXIT=$?" >> $GITHUB_ENV
          
      - name: 🛡️ Guard-Rail Notice (Init mode)
        if: env.INIT_RUN == 'true'
        run: |
          echo "🛡️ INIT_RUN=true detected - Full sync bypassed"
          echo "📋 Review the dry-run report, then set INIT_RUN=false to enable production sync"
          
      - name: 📦 Upload Sync Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bridge-sync-artifacts-${{ github.run_id }}
          path: |
            paneudaemonium/artifacts/*.zip
            paneudaemonium/artifacts/*.md
            paneudaemonium/artifacts/*.json
          retention-days: 30
          
      - name: 📊 Sync Report Summary
        if: always()
        run: |
          echo "## 🌀 Bridge Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: Simulation (Private repos not accessible)" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ env.CHANGES_DETECTED }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry-run Exit**: ${{ env.DRY_RUN_EXIT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Full Sync Exit**: ${{ env.FULL_SYNC_EXIT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🛡️ **Guard Rail Status**: INIT_RUN=${{ secrets.INIT_RUN }}" >> $GITHUB_STEP_SUMMARY
          echo "📝 **Note**: Full functionality requires SYNC_TOKEN secret for private repo access" >> $GITHUB_STEP_SUMMARY